<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Run {{ job_id }}</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1 class="title">Run {{ job_id }}</h1>
        <div class="subtitle" style="display:flex; gap:12px; align-items:center;">
          <span id="status-pill" class="pill">
            <span id="status-dot" class="status-dot" style="width:8px;height:8px;border-radius:999px;background:#94a3b8;"></span>
            <span id="status">starting...</span>
          </span>
          <span class="muted">Elapsed: <span id="elapsed">0s</span></span>
        </div>
      </header>

      <div class="card">
        <div class="muted">Command</div>
        <div style="display:flex; gap:12px; align-items:center;">
          <pre id="argv" class="output" style="flex:1;"></pre>
          <button id="copy-argv" class="btn">Copy</button>
        </div>
      </div>

      <div class="card">
        <div class="muted" style="display:flex; justify-content:space-between;">
          <span>Progress</span>
          <span id="progress-label">Waiting...</span>
        </div>
        <div class="progress">
          <div id="progress-bar" class="progress-shimmer"></div>
          <div id="progress-done" class="progress-done"></div>
        </div>
      </div>

      <div class="card">
        <div class="muted" style="display:flex; justify-content:space-between;">
          <span>Live output</span>
          <label class="muted" style="display:flex; gap:8px; align-items:center;">
            <input id="auto-scroll" type="checkbox" checked />
            Auto-scroll
          </label>
        </div>
        <pre id="output" class="output"></pre>
      </div>

      <div style="margin-top:16px; display:flex; gap:12px;">
        <a href="/" class="btn-link">New run</a>
        <a href="/jobs" class="btn-link">All runs</a>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const statusPill = document.getElementById("status-pill");
      const statusDot = document.getElementById("status-dot");
      const outputEl = document.getElementById("output");
      const argvEl = document.getElementById("argv");
      const elapsedEl = document.getElementById("elapsed");
      const progressLabel = document.getElementById("progress-label");
      const progressBar = document.getElementById("progress-bar");
      const progressDone = document.getElementById("progress-done");
      const autoScroll = document.getElementById("auto-scroll");
      const copyBtn = document.getElementById("copy-argv");
      let startedAt = null;

      function formatElapsed(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}m ${s}s`;
      }

      function updateStatus(status, exitCode) {
        statusEl.textContent = status;
        if (status === "running") {
          statusPill.className = "inline-flex items-center gap-2 rounded-full bg-indigo-100 px-3 py-1 text-indigo-700";
          statusDot.className = "inline-block h-2 w-2 rounded-full bg-indigo-500 animate-pulse";
          progressLabel.textContent = "Running...";
          progressBar.style.display = "block";
          progressDone.style.display = "none";
        } else {
          const ok = exitCode === 0;
          statusPill.className = `inline-flex items-center gap-2 rounded-full px-3 py-1 ${ok ? "bg-emerald-100 text-emerald-700" : "bg-red-100 text-red-700"}`;
          statusDot.className = `inline-block h-2 w-2 rounded-full ${ok ? "bg-emerald-500" : "bg-red-500"}`;
          progressLabel.textContent = ok ? "Done" : "Error";
          progressBar.style.display = "none";
          progressDone.style.display = "block";
          progressDone.style.width = "100%";
          progressDone.className = `h-full ${ok ? "bg-emerald-500" : "bg-red-500"}`;
        }
      }

      function maybeScroll() {
        if (!autoScroll.checked) return;
        outputEl.scrollTop = outputEl.scrollHeight;
      }

      copyBtn.addEventListener("click", () => {
        const text = argvEl.textContent || "";
        if (!text) return;
        navigator.clipboard.writeText(text);
      });

      async function poll() {
        const res = await fetch("/status/{{ job_id }}");
        if (!res.ok) return;
        const data = await res.json();
        updateStatus(data.status, data.exit_code);
        outputEl.textContent = data.output || "";
        if (data.argv && data.argv.length) {
          argvEl.textContent = ["cbc-radio-cli", ...data.argv].join(" ");
        }
        if (startedAt === null && data.started_at) {
          startedAt = data.started_at;
        }
        if (startedAt) {
          const elapsed = Math.max(0, Math.floor(Date.now() / 1000 - startedAt));
          elapsedEl.textContent = formatElapsed(elapsed);
        }
        maybeScroll();
        if (data.status !== "running") return;
        setTimeout(poll, 1000);
      }
      poll();
    </script>
  </body>
</html>
